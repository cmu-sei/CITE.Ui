<!--
Copyright 2022 Carnegie Mellon University. All Rights Reserved.
 Released under a MIT (SEI)-style license, please see LICENSE.md in the project root for license information or contact permission@sei.cmu.edu for full terms.
-->

<div class="form-container">
  <mat-table
    [dataSource]="selectedScoringModel.scoringCategories | displayOrder"
    class="full-width"
    *ngIf="
      selectedEvaluation.id &&
      teamId &&
      selectedScoringModel &&
      displayedMoveNumber >= 0
    "
  >
    <!-- Description Definition -->
    <ng-container matColumnDef="scoringCategoryDescription">
      <mat-header-cell *matHeaderCellDef>
        <div
          class="navigation-font"
          fxLayout="row"
          fxLayoutAlign="space-between center"
        >
          <span style="transform: scale(0.8)">
            <!-- User -->
            <button
              mat-flat-button
              color="user"
              class="background-button"
              (click)="selectDisplayedSubmission('user')"
              *ngIf="displaying === 'user'"
              title="Your personal score"
            >
              User
            </button>
            <button
              mat-stroked-button
              class="plain-button"
              (click)="selectDisplayedSubmission('user')"
              *ngIf="displaying !== 'user'"
              title="Your private personal score"
            >
              User
            </button>
            <!-- Team -->
            <button
              mat-flat-button
              color="team"
              class="background-button"
              (click)="selectDisplayedSubmission('team')"
              *ngIf="displaying === 'team'"
              title="Your team's score"
            >
              Team
            </button>
            <button
              mat-stroked-button
              class="plain-button"
              (click)="selectDisplayedSubmission('team')"
              *ngIf="displaying !== 'team'"
              title="Your team's score"
            >
              Team
            </button>
            <!-- Team Avg -->
            <button
              mat-flat-button
              color="team-avg"
              class="background-button"
              (click)="selectDisplayedSubmission('team-avg')"
              *ngIf="displaying === 'team-avg'"
              title="The average of all user scores for your team"
            >
              Team Avg
            </button>
            <button
              mat-stroked-button
              class="plain-button"
              (click)="selectDisplayedSubmission('team-avg')"
              *ngIf="displaying !== 'team-avg'"
              title="The average of all user scores for your team"
            >
              Team Avg
            </button>
            <!-- Group Avg -->
            <button
              mat-flat-button
              color="group-avg"
              class="background-button"
              (click)="selectDisplayedSubmission('group-avg')"
              *ngIf="displaying === 'group-avg'"
              title="The average of all team scores for your group"
            >
              Group Avg
            </button>
            <button
              mat-stroked-button
              class="plain-button"
              (click)="selectDisplayedSubmission('group-avg')"
              *ngIf="displaying !== 'group-avg' && showGroupAvgScore"
              title="The average of all team scores for your group"
            >
              Group Avg
            </button>
            <!-- Official -->
            <button
              mat-flat-button
              color="official"
              class="background-button"
              (click)="selectDisplayedSubmission('official')"
              *ngIf="displaying === 'official'"
              title="The official score for this move"
            >
              Official
            </button>
            <button
              mat-stroked-button
              class="plain-button"
              (click)="selectDisplayedSubmission('official')"
              *ngIf="displaying !== 'official' && showOfficialScore"
              title="The official score for this move"
            >
              Official
            </button>
          </span>
        </div>
        <span class="title-font" [ngClass]="displayedScoreClass" title="{{ displayedScoreHover }}"
          >{{ displayedSubmission.score | number: '1.2-2' }}</span
        >
        <div
          class="title-font"
          fxLayout="row"
          fxLayoutAlign="space-between center"
        >
          <span
            class="move-buttons"
          >
            <button
              mat-raised-button
              [ngClass]="buttonClass"
              class="move-button background-button"
              *ngIf="showSubmitButton"
              (click)="completeSubmission()"
            >
              Submit
            </button>
            <button
              mat-raised-button
              [ngClass]="buttonClass"
              class="move-button background-button"
              *ngIf="showReopenButton"
              (click)="activateSubmission()"
            >
              Reopen
            </button>
            <button
              mat-raised-button
              [ngClass]="buttonClass"
              class="move-button background-button"
              *ngIf="showModifyControls"
              (click)="clearSelections()"
            >
              Clear
            </button>
            <button
              mat-raised-button
              [ngClass]="buttonClass"
              class="move-button background-button"
              *ngIf="showModifyControls"
              (click)="presetSelections()"
            >
              Preset
            </button>
          </span>
        </div>
      </mat-header-cell>

      <!-- scorecard display -->
      <mat-cell
        *matCellDef="let scoringCategory"
        class="form-container"
        [ngClass]="tableClass"
      >
        <div class="scoring-category-description" [ngClass]="tableClass">
          {{ scoringCategory.displayOrder }}. {{ scoringCategory.description }}
          <span *ngIf="scoringCategory.calculationMethodId > 0">
            &nbsp;&nbsp;-&nbsp;&nbsp;[{{
              categoryScore(scoringCategory.id) | number: '1.0-0'
            }}]
          </span>
        </div>
        <mat-table
          [dataSource]="scoringCategory.scoringOptions | displayOrder"
          class="full-width"
          [ngClass]="tableClass"
        >
          <ng-container
            matColumnDef="scoringOptionDescription"
            class="description-cell"
          >
            <mat-cell
              *matCellDef="let scoringOption"
              class="description-container"
              [ngClass]="tableClass"
            >
              <div [ngClass]="scoringOption.isModifier ? 'indent-div' : ''">
                <div>
                  <mat-checkbox
                    [aria-label]="scoringOption.description"
                    *ngIf="!displayedSubmission.scoreIsAnAverage"
                    [checked]="isSelected(scoringCategory.id, scoringOption.id)"
                    [disabled]="!showModifyControls"
                    [matTooltip]="selectedBy(scoringCategory.id, scoringOption.id)"
                    (change)="
                      toggleOption($event, scoringCategory.id, scoringOption.id)
                    "
                  >
                  {{ scoringOption.description }} &nbsp;
                </mat-checkbox>
                  <span *ngIf="displayedSubmission.scoreIsAnAverage">
                    [{{ selectedCount(scoringCategory.id, scoringOption.id) }}]
                  &nbsp;&nbsp;{{ scoringOption.description }}
                </span>
                <button
                    id="add-comment"
                    aria-label="Add Comment"
                    mat-icon-button
                    class="small-button"
                    *ngIf="showModifyControls"
                    (click)="addComment(addCommenttemplate, scoringOption)"
                    title="Add Comment"
                  >
                    <mat-icon
                      class="icon-color small-icon"
                      svgIcon="add-comment"
                      aria-hidden="false"
                    ></mat-icon>
                  </button>
                </div>
                <div class="comment-list">
                  <div
                    *ngFor="
                      let comment of optionComments(
                        scoringCategory.id,
                        scoringOption.id
                      )
                    "
                  >
                    {{ comment.comment }}
                    <button
                      aria-label="Edit Comment"
                      mat-icon-button
                      class="small-button"
                      *ngIf="showModifyControls"
                      (click)="
                        editComment(addCommenttemplate, scoringOption, comment)
                      "
                      title="Edit Comment"
                    >
                      <mat-icon
                        class="icon-color small-icon"
                        svgIcon="ic_square_edit_outline"
                        aria-hidden="false"
                      ></mat-icon>
                    </button>
                    <button
                      aria-label="Delete Comment"
                      mat-icon-button
                      class="small-button"
                      *ngIf="showModifyControls"
                      (click)="deleteComment(comment)"
                      title="Delete Comment"
                    >
                      <mat-icon
                        class="icon-color small-icon"
                        svgIcon="ic_trash_can"
                        aria-hidden="false"
                      ></mat-icon>
                    </button>
                  </div>
                </div>
              </div>
            </mat-cell>
          </ng-container>
          <ng-container matColumnDef="value">
            <mat-cell
              *matCellDef="let scoringOption"
              class="value-container"
              [ngClass]="tableClass"
            >
              <div class="value-div">
                {{
                  scoringCategory.calculationMethodId == 0 ||
                  scoringOption.isModifier
                    ? ' '
                    : scoringOption.value
                }}
              </div>
              <div
                *ngFor="
                  let comment of optionComments(
                    scoringCategory.id,
                    scoringOption.id
                  )
                "
              >
                &nbsp;<br />
              </div>
            </mat-cell>
          </ng-container>
          <mat-row
            *matRowDef="let row; columns: ['scoringOptionDescription', 'value']"
          ></mat-row>
        </mat-table>
      </mat-cell>
    </ng-container>

    <!-- Header and Row Declarations -->
    <mat-header-row
      *matHeaderRowDef="['scoringCategoryDescription']"
    ></mat-header-row>
    <mat-row
      *matRowDef="let row; columns: ['scoringCategoryDescription']"
    ></mat-row>
  </mat-table>

  <div
    *ngIf="!selectedEvaluation.id || !selectedScoringModel"
    class="text-center"
  >
    <p>&nbsp;</p>
    <h1>An evaluation has not been properly configured.</h1>
    <h1>Please contact your administrator.</h1>
  </div>
  <div
    *ngIf="selectedEvaluation.id && selectedScoringModel && !teamId"
    class="text-center"
  >
    <p>&nbsp;</p>
    <h1>You have not been given appropriate access to this application.</h1>
    <h1>Please contact your administrator.</h1>
  </div>
</div>

<ng-template #addCommenttemplate>
  <h1>Add a comment ...</h1>
  <mat-form-field class="full-width">
    <textarea
      matInput
      placeholder="{{ commentOptionDescription }}"
      [(ngModel)]="currentComment"
    ></textarea>
  </mat-form-field>

  <mat-dialog-actions>
    <button mat-button mat-dialog-close>Cancel</button>
    <!-- The mat-dialog-close directive optionally accepts a value as a result for the dialog. -->
    <button mat-button [mat-dialog-close]="true">Save</button>
  </mat-dialog-actions>
</ng-template>
